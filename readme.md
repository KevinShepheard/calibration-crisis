Calibration Crisis: Residual Structure in Type Ia Supernovae
------------------------------------------------------------

DOI (Zenodo): https://doi.org/10.5281/zenodo.18190430

This repository contains the exact, byte-for-byte scripts used to generate the analyses and figure reported in the accompanying paper:

Disentangling Calibration Bias and Ordered Structure in Type Ia Supernova Residuals  
Kevin Shepheard, 2026

The purpose of this repository is full computational reproducibility.  
Nothing here is exploratory, tuned, or cosmetic. Each script corresponds directly to a test described in the paper.

------------------------------------------------------------
Repository Structure (Public Release Layout)
------------------------------------------------------------

Assumed layout for all commands below:

.
- data/
   - pantheonplus/
      - distance_moduli/
         - Pantheon_SH0ES.dat
   - bao-all/
      - chain.*.txt
- test1_residual_structure_baseline.py
- test2_host_mass_step_fe.py
- test3_residual_dipole_estimation.py
- test4_bao_shape_projection.py
- test5_dipole_footprint_robustness.py
- test6_structure_population_association.py
- test7_global_bao_blocked_pvalue.py
- test8_admissible_correction_rerun.py
- guardrail_operator_viz.py
- export_guardrailed_residuals.py
- README.md

------------------------------------------------------------
Test Order (Intentional)
------------------------------------------------------------

The tests are designed to be run in order. Each test constrains the interpretation space for the next.

1. Test 1 — Baseline residual structure and covariate association  
   (`test1_residual_structure_baseline.py`) Establishes ordered structure in redshift-sorted SN residuals.

2. Test 2 — Host-mass step with survey fixed effects  
   (`test2_host_mass_step_fe.py`) Tests whether the structure is explained by the canonical host-mass step.

3. Test 3 — Residual dipole estimation  
   (`test3_residual_dipole_estimation.py`) Fits and characterizes a dipole in cleaned residuals.

4. Test 4 — BAO shape projection  
   (`test4_bao_shape_projection.py`) Tests whether expansion-history freedom explains the structure.

5. Test 5 — Dipole footprint robustness  
   (`test5_dipole_footprint_robustness.py`) Stress-tests dipole stability under per-survey fits, jackknifes, and matched hemispheres.

6. Test 6 — Structure–population association  
   (`test6_structure_population_association.py`) Quantifies correlations between residual structure and SALT2 population parameters.

7. Test 7 — Global BAO blocked p-value  
   (`test7_global_bao_blocked_pvalue.py`) Corrects for parameter-search multiplicity across w0–wa scans.

8. Test 8 — Admissible correction rerun  
   (`test8_admissible_correction_rerun.py`) Builds an admissible correction model and reruns guardrail diagnostics.

Running the Tests

### 1) Create and use a virtual environment

From the repository root:

```bash
python3 -m venv .venv
source .venv/bin/activate

python3 -m pip install -U pip
python3 -m pip install numpy pandas scipy

# Sanity-check you're using the venv interpreter
which python3
python3 -c "import sys, pandas; print(sys.executable); print('pandas', pandas.__version__)"
```

If `which python3` does not point into `.venv/`, run scripts explicitly via:

```bash
.venv/bin/python3 <script>.py
```

### 2) Run tests 1–8 (in order)

All scripts print results to stdout.

```bash
python3 test1_residual_structure_baseline.py
python3 test2_host_mass_step_fe.py
python3 test3_residual_dipole_estimation.py
python3 test4_bao_shape_projection.py
python3 test5_dipole_footprint_robustness.py
python3 test6_structure_population_association.py
python3 test7_global_bao_blocked_pvalue.py
python3 test8_admissible_correction_rerun.py
```

Visualization

The operator-level visualization shown in the paper is generated by:

`guardrail_operator_viz.py`

This script produces an operator-level visualization consisting of:
- an admissible-correction phase portrait
- an ordering-structure collapse curve

The script uses the same cleaned residual construction and admissible feature class
as the final guardrail tests, and is fully deterministic.

Run from the repository root:

```bash
mkdir -p out
python3 guardrail_operator_viz.py \
   --sn data/pantheonplus/distance_moduli/Pantheon_SH0ES.dat \
   --out out/guardrail_operator_viz.png
```

------------------------------------------------------------
Export (Public Derived Data Product)
------------------------------------------------------------

To export the guardrailed residual table (post admissible-correction):

```bash
mkdir -p data/derived
python3 export_guardrailed_residuals.py \
   --sn data/pantheonplus/distance_moduli/Pantheon_SH0ES.dat \
   --out data/derived/pantheon_guardrailed_residuals.csv
```

### Output notes: `pantheon_guardrailed_residuals.csv`

Multiple rows per `CID` reflect distinct Pantheon+/SH0ES entries (e.g. multiple fits or surveys) and are intentionally not collapsed.

------------------------------------------------------------
Design Principles
------------------------------------------------------------

- No hidden preprocessing  
- No cosmology-dependent assumptions upstream of tests  
- No reuse of corrected data before validation  
- Blocked permutation tests preserve survey and redshift structure  
- All randomness is seeded for determinism  

The code is intended to be read, audited, and rerun.

------------------------------------------------------------
License and Attribution
------------------------------------------------------------

Released under the MIT License.

You are free to use, modify, and redistribute this code, with attribution, under the terms of the MIT License.

------------------------------------------------------------
Notes
------------------------------------------------------------

This repository accompanies the paper and is not a general-purpose framework.  
It is a minimal, explicit implementation of a specific inference pipeline.

If something here fails, that failure is part of the result.